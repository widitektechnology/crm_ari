# Configuración Nginx ULTRA-SEGURA para eliminar Mixed Content
# Para: crm.arifamilyassets.com
# Archivo: fix-nginx-mixed-content.conf

# ================================
# API PROXY CON HEADERS SEGUROS
# ================================
location /api/ {
    # FORZAR HTTPS HEADERS
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;  # IMPORTANTE: siempre HTTPS
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
    
    # Headers de seguridad anti Mixed Content
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "upgrade-insecure-requests" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Proxy al backend local
    proxy_pass http://127.0.0.1:8000/;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffering
    proxy_buffering off;
    proxy_request_buffering off;
}

# ================================
# HEALTH CHECK SEGURO
# ================================
location /health {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;  # IMPORTANTE: siempre HTTPS
    
    add_header Content-Security-Policy "upgrade-insecure-requests" always;
    
    proxy_pass http://127.0.0.1:8000/health;
}

# ================================
# SPA ROUTING SEGURO
# ================================
location / {
    try_files $uri $uri/ /index.html;
    
    # Headers de seguridad para SPA
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "upgrade-insecure-requests; default-src 'self' https: 'unsafe-inline' 'unsafe-eval'" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Cache para HTML
    add_header Cache-Control "no-cache, must-revalidate" always;
}

# ================================
# ASSETS ESTÁTICOS SEGUROS
# ================================
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary Accept-Encoding;
    
    # Headers de seguridad para assets
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "upgrade-insecure-requests" always;
    add_header X-Content-Type-Options nosniff always;
}

# ================================
# REDIRECCIÓN HTTP -> HTTPS
# ================================
# Esto debería ir en la configuración del servidor HTTP (puerto 80)
# server {
#     listen 80;
#     server_name crm.arifamilyassets.com;
#     return 301 https://$server_name$request_uri;
# }